package com.example.spotty.ViewModels;

import android.content.Context;
import android.content.SharedPreferences;
import android.util.Log;

import androidx.lifecycle.LiveData;
import androidx.lifecycle.MutableLiveData;
import androidx.lifecycle.ViewModel;

import com.example.spotty.service.model.LocalPreferences;
import com.example.spotty.service.model.User;
import com.example.spotty.service.repository.LocalPreferencesRepository;
import com.example.spotty.service.repository.ServerRepository;
import com.google.firebase.auth.FirebaseAuth;
import com.google.firebase.auth.FirebaseUser;

import java.util.List;

/**
 * The type User profile view model.
 */
public class UserProfileViewModel extends ViewModel {
    private static final String PREF_USER = "UserFile";
    private final ServerRepository serverRepository = ServerRepository.getInstance();
    private final LocalPreferencesRepository localPreferencesRepository = LocalPreferencesRepository.getInstance(serverRepository);
    private FirebaseAuth mAuth = FirebaseAuth.getInstance();
    private FirebaseUser mUser;

    /**
     * Gets user.
     *
     * @return the user
     */
    public LiveData<User> getUser() {
        return serverRepository.getLoggedInUser();
    }

    /**
     * get all users
     *
     * @return LiveData<List                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               <                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               User>>
     */
    public LiveData<List<User>> getUsers() {
        return serverRepository.getAllUsers();
    }

    /**
     * Check user in.
     *
     * @param context    the context
     * @param locationID the location id
     */
    public void checkUserIn(Context context, int locationID) {
        serverRepository.checkInUser(locationID);
        SharedPreferences.Editor editor = context.getSharedPreferences(PREF_USER, Context.MODE_PRIVATE).edit();
        editor.putInt("location", locationID);
        editor.putBoolean("isCheckedIn", true);
        editor.apply();
    }

    /**
     * Check user out.
     *
     * @param context the context
     */
    public void checkUserOut(Context context) {
        serverRepository.checkOutUser();
        SharedPreferences.Editor editor = context.getSharedPreferences(PREF_USER, Context.MODE_PRIVATE).edit();
        editor.putBoolean("isCheckedIn", false);
        editor.apply();
    }

    /**
     * Is checked in boolean.
     *
     * @param context    the context
     * @param locationID the location id
     * @return the boolean
     */
    public boolean isCheckedIn(Context context, int locationID) {
        if (context.getSharedPreferences(PREF_USER, Context.MODE_PRIVATE).getInt("location", -1) == locationID) {
            return context.getSharedPreferences(PREF_USER, Context.MODE_PRIVATE).getBoolean("isCheckedIn", false);
        }
        return false;
    }

    /**
     * Sync settings to server.
     *
     * @param context the context
     */
    public void syncSettingsToServer(Context context) {
        LocalPreferences localPreferences = localPreferencesRepository.getLocalPreferences(context);
        if (localPreferences.sync)
            serverRepository.sendLocalPreferences(localPreferences);
    }

    /**
     * Gets settings from server.
     *
     * @param context the context
     */
    public void getSettingsFromServer(Context context) {
        serverRepository.getLocalPreferences(context);
    }

    /**
     * Log out.
     *
     * @param context the context
     */
    public void logOut(Context context) {
        localPreferencesRepository.logOut(context);
        if (mUser != null) {
            mUser.delete();
        }
    }


    /**
     * send a login request to firebase and populate the {@link FirebaseUser} field and sets the {@link UserProfileViewModel} user
     *
     * @param email    the email
     * @param password the password
     */
    public LiveData<Boolean> logIn(String email, String password, Context context) {
        MutableLiveData<Boolean> succes = new MutableLiveData<>();
        mAuth.signInWithEmailAndPassword(email, password).addOnCompleteListener(task -> {
            if (task.isSuccessful()) {
                mUser = mAuth.getCurrentUser();
                mUser.getIdToken(false).addOnCompleteListener(token -> {
                    serverRepository.setLoggedInUser(new User(mUser.getEmail(), token.getResult().getToken(), mUser.getUid()), context);
                    succes.postValue(true);
                    if (localPreferencesRepository.getUserPasswordSaved(context)) {
                        localPreferencesRepository.setUserSavedPassword(context, password);
                    }
                });
            } else {
                Log.d("firebase", "failure when trying to login ", task.getException());
                succes.postValue(false);
            }
        });
        return succes;
    }

    /**
     * Is logged in boolean.
     *
     * @param context the context
     * @return the boolean
     */
    public boolean isLoggedIn(Context context) {
        return localPreferencesRepository.isLoggedIn(context);
    }

    /**
     * Gets friends.
     *
     * @return the friends
     */
    public LiveData<List<User>> getFriends() {
        return serverRepository.getFriends();
    }

    /**
     * Gets friends in location.
     *
     * @param id the id
     * @return the friends in location
     */
    public LiveData<List<User>> getFriendsInLocation(int id) {
        return serverRepository.getFriendsAtLocation(id);
    }

    /**
     * approve a friend request.
     *
     * @param email
     * @return
     */
    public LiveData<Boolean> approveFriendRequest(String email) {
        return serverRepository.acceptFriendRequest(email);
    }

    /**
     * Send a friend request.
     *
     * @param email
     * @return
     */
    public LiveData<Boolean> sendFriendRequest(String email) {
        return serverRepository.sendFriendRequest(email);
    }

    /**
     * Register.
     *
     * @param email    the email
     * @param password the password
     */
    public LiveData<Boolean> register(String email, String password, Context context) {
        MutableLiveData<Boolean> succes = new MutableLiveData<>();
        mAuth.createUserWithEmailAndPassword(email, password)
                .addOnCompleteListener(task -> {
                    if (task.isSuccessful()) {
                        mUser = mAuth.getCurrentUser();
                        serverRepository.setLoggedInUser(new User(mUser.getEmail(), mUser.getUid(), mUser.getUid()), context);
                        succes.postValue(true);
                    } else {
                        Log.d("firebase", "Failure when trying to register user ", task.getException());
                        succes.postValue(false);
                    }
                });
        return succes;
    }

    /**
     * Gets user name.
     *
     * @param context the context
     * @return the user name
     */
    public String getUserName(Context context) {
        return localPreferencesRepository.getUser(context).mail;
    }

    /**
     * Sets user level.
     *
     * @param context the context
     * @param level   the level
     */
// voor is admin!
    public void setUserLevel(Context context, String level) {
        localPreferencesRepository.setUserLevel(context, level);
    }

    /**
     * Gets user level.
     *
     * @param context the context
     * @return the user level
     */
    public String getUserLevel(Context context) {
        return localPreferencesRepository.getUserLevel(context);
    }

    /**
     * Sets user location.
     *
     * @param context the context
     * @param city    the city
     */
    public void setUserLocation(Context context, String city) {
        localPreferencesRepository.setUserLocation(context, city);
    }

    /**
     * Gets user city.
     *
     * @param context the context
     * @return the user city
     */
    public String getUserCity(Context context) {
        return localPreferencesRepository.getUserCity(context);
    }
}